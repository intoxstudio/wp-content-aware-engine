/*!
 * @package WP Content Aware Engine
 * @author Joachim Jensen <jv@intox.dk>
 * @license GPLv3
 * @copyright 2018 by Joachim Jensen
 */
var CAE=CAE||{};!function(a,b){"use strict";b.settings={views:{}},b.Models={},b.Models.Alert=Backbone.Model.extend({defaults:{text:"",success:!0},sync:function(){return!1},url:"",reset:function(){this.set(this.defaults)}}),b.Models.Condition=Backbone.Model.extend({unsaved:{prompt:WPCA.unsaved,unloadWindowPrompt:!0},defaults:{module:null,label:"",placeholder:"",values:[],default_value:null},initialize:function(){this.startTracking(),this.on("destroy",this.stopTracking,this)},sync:function(){return!1},url:""}),b.Models.Group=Backbone.Model.extend({unsaved:{prompt:WPCA.unsaved,unloadWindowPrompt:!0},defaults:function(){var a=WPCA.meta_default;return a.id=null,a.status="publish",a.exposure=1,a},initialize:function(){this.startTracking(),this.on("destroy",this.stopTracking,this),this.conditions||(this.conditions=new b.Models.ConditionCollection)},parse:function(a){var c=[];if(_.has(a,"conditions")){for(var d in a.conditions)if(a.conditions.hasOwnProperty(d)){var e=[],f=a.conditions[d];for(var g in f.data)f.data.hasOwnProperty(g)&&e.push({text:f.data[g],id:g});delete f.data,f.module=d,f.values=e,c.push(f)}delete a.conditions}return this.conditions=new b.Models.ConditionCollection(c),a},sync:function(){return!1},url:""}),b.Models.GroupCollection=Backbone.Collection.extend({model:b.Models.Group,parse:function(a){return a}}),b.Models.ConditionCollection=Backbone.Collection.extend({model:b.Models.Condition}),b.Views={},b.Views.Alert=Backbone.Epoxy.View.extend({bindings:"data-vm",tagName:"div",className:"wpca-alert",template:"<div data-vm=\"classes:{'wpca-success':success,'wpca-error':not(success)},text:text\"></div>",timer:4e3,success:function(a){this.model.set({text:a,success:!0})},failure:function(a){this.model.set({text:a,success:!1})},dismiss:function(){var a=this;this.$el.fadeOut("slow",function(){a.model.reset()})},initialize:function(){this.listenTo(this.model,"change:text",this.show),this.$el.appendTo("body").hide().html(this.template)},show:function(){if(""!==this.model.get("text")){this.$el.fadeIn("slow");var a=this;setTimeout(function(){a.dismiss()},this.timer)}}}),b.Views.Condition=Backbone.Epoxy.View.extend({bindings:"data-vm",model:b.Models.Condition,tagName:"div",className:"cas-condition",templateName:"#wpca-template-condition",events:{"click .js-wpca-condition-remove":"removeModel"},initialize:function(){this.listenTo(this.model,"destroy",this.remove);var b=a(this.templateName);b.length?(this.template=b.html(),this.$el.append(this.template),this.createSuggestInput()):this.model.destroy()},removeModel:function(a){var b=this;this.$el.slideUp(300,function(){b.model.destroy()})},createSuggestInput:function(){var b=this.$el.find(".js-wpca-suggest");if(b.length){var c=this.model,e=this.model.get("values"),f=a("<div></div>").html(c.get("placeholder")).text();b.select2({cachedResults:{},quietMillis:400,searchTimer:null,type:c.get("module"),theme:"wpca",dir:WPCA.text_direction,placeholder:f,minimumInputLength:0,closeOnSelect:!0,width:"100%",language:{noResults:function(){return WPCA.noResults},searching:function(){return WPCA.searching+"..."},loadingMore:function(){return WPCA.loadingMore+"..."}},nextSearchTerm:function(a,b){return b},templateResult:function(b){return b.level?a('<span class="wpca-level-'+b.level+'">'+b.text+"</span>"):b.text},data:e,dataAdapter:d.wpcaDataAdapter,ajax:{}}).on("select2:selecting",function(a){b.data("forceOpen",!0)}).on("select2:closing",function(a){b.data("forceOpen")&&(a.preventDefault(),b.data("forceOpen",!1))}),e.length&&b.val(_.map(e,function(a){return a.id})).trigger("change"),b.on("change",function(a){var d=b.select2("data");c.set("values",d)})}}}),b.Views.Group=Backbone.Epoxy.View.extend({bindings:"data-vm",model:b.Models.Group,tagName:"li",className:"cas-group-single",template:a("#wpca-template-group").html(),itemView:function(a){if(b.Views[a.model.get("module")])var c=new(b.Views[a.model.get("module")])(a);else var c=new b.Views.Condition(a);return c},events:{"change .js-wpca-add-and":"addConditionModel","click .js-wpca-save-group":"saveGroup","click .js-wpca-options":"showOptions"},computeds:{statusNegated:{deps:["status"],get:function(a){return"negated"==a},set:function(a){var b=a?"negated":"publish";this.setBinding("status",b)}},exposureSingular:{deps:["exposure"],get:function(a){return a<=1},set:function(a){var b=this.getBinding("exposureArchive"),c=a&&b?b?1:0:2;this.setBinding("exposure",c)}},exposureArchive:{deps:["exposure"],get:function(a){return a>=1},set:function(a){var b=this.getBinding("exposureSingular"),c=a&&b?b?1:2:0;this.setBinding("exposure",c)}}},bindingFilters:{int:{get:function(a){return a?1:0},set:function(a){return a?1:0}}},initialize:function(){this.collection=this.model.conditions,this.$el.hide().html(this.template).fadeIn(300),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"unsavedChanges",this.saveChanges),this.listenTo(this.model.conditions,"unsavedChanges",this.saveChanges),this.listenTo(this.model.conditions,"add remove",this.saveAddRemove)},showOptions:function(b){a(b.delegateTarget).find(".cas-group-options").slideToggle(200),a(b.currentTarget).toggleClass("active")},saveChanges:function(a,b){a?c.start(this):c.clear(this)},saveAddRemove:function(a,b,d){b.length?d.add?""!==a.get("default_value")&&c.start(this):this.model.get("id")&&c.start(this):(c.clear(this),this.model.get("id")?this.saveGroup():this.removeModel())},addConditionModel:function(c){var d=a(c.currentTarget);if(d.val()&&isNaN(d.val())&&!this.model.conditions.findWhere({module:d.val()})){var e=d.children(":selected"),f=new b.Models.Condition({module:d.val(),label:e.text(),placeholder:e.data("placeholder"),default_value:e.data("default")});this.model.conditions.add(f)}d.val(-1).blur()},removeModel:function(){var a=this;this.$el.slideUp(400,function(){a.model.destroy()})},saveGroup:function(b){var c=this.$el.find(".spinner"),e=this.$el.find(".js-wpca-save-group"),f=this;e.attr("disabled",!0),c.addClass("is-active");var g=_.clone(this.model.attributes);g.action="wpca/add-rule",g.token=d.nonce,g.current_id=d.sidebarID,g.post_type=WPCA.post_type,g.conditions={},this.model.conditions.each(function(a){a.get("values").length?g.conditions[a.get("module")]=a.get("values").map(function(a){return a.id}):""!==a.get("default_value")&&(g.conditions[a.get("module")]=[a.get("default_value")])}),a.ajax({url:ajaxurl,data:g,dataType:"JSON",type:"POST",success:function(a){d.alert.success(a.message),a.removed?f.removeModel():a.new_post_id&&f.model.set("id",a.new_post_id,{silent:!0}),a.removed||(e.hide(),c.removeClass("is-active"),f.model.restartTracking(),f.model.conditions.each(function(a){a.restartTracking()}))},error:function(a,b,f){e.attr("disabled",!1).show(),c.removeClass("is-active"),d.alert.failure(a.responseText)}})},slideRemove:function(){this.$el.slideUp(400,function(){this.remove()})}}),b.Views.GroupCollection=Backbone.Epoxy.View.extend({bindings:"data-vm",el:"#cas-groups",collection:b.Models.GroupCollection,events:{"change .js-wpca-add-or":"addGroupModel","click .js-wpca-save":"saveAll"},itemView:function(a){return new b.Views.Group(a)},addGroupModel:function(c){var d=a(c.currentTarget);if(d.val()&&isNaN(d.val())){var e=new b.Models.Group,f=d.children(":selected"),g=new b.Models.Condition({module:d.val(),label:f.text(),placeholder:f.data("placeholder"),default_value:f.data("default")});this.collection.add(e),e.conditions.add(g)}d.val(-1).blur()}}),a.fn.select2.amd.require(["select2/selection/search"],function(a){a.prototype.searchRemoveChoice=function(a,b){this.trigger("unselect",{data:b}),this.$search.val(""),this.handleSearch()}},null,!0),a.fn.select2.amd.require(["select2/results"],function(a){a.prototype.ensureHighlightVisible=function(){this.$results.resize()}},null,!0),a.fn.select2.amd.define("select2/data/wpcaAdapter",["select2/data/array","select2/utils"],function(b,c){function e(a,b){e.__super__.constructor.call(this,a,b)}return c.Extend(e,b),e.prototype.query=function(b,c){b.term=b.term||"";var e=this.options.options,f=e.cachedResults[b.term],g=b.page||1;if(f&&f.page>=g){if(!(g>1))return void c({results:f.items,pagination:{more:f.more}});g=f.page}clearTimeout(e.searchTimer),e.searchTimer=setTimeout(function(){a.ajax({url:ajaxurl,data:{search:b.term,paged:g,action:"wpca/module/"+e.type,sidebar_id:d.sidebarID,nonce:d.nonce},dataType:"JSON",type:"POST",success:function(a){var d=!(a.length<20);e.cachedResults[b.term]={page:g,more:d,items:f?e.cachedResults[b.term].items.concat(a):a},c({results:a,pagination:{more:d}})}})},e.quietMillis)},e});var c={treshold:2e3,timerQueue:{},start:function(a){this.clear(a);var b=this;this.timerQueue[a.cid]=window.setTimeout(function(){b.set(a)},this.treshold)},set:function(a){a.saveGroup()},clear:function(a){a&&this.timerQueue[a.cid]&&window.clearInterval(this.timerQueue[a.cid])}},d={nonce:a("#_ca_nonce").val(),sidebarID:a("#post_ID").val(),alert:null,wpcaDataAdapter:a.fn.select2.amd.require("select2/data/wpcaAdapter"),init:function(){this.alert=new b.Views.Alert({model:new b.Models.Alert}),b.conditionGroups=new b.Views.GroupCollection({collection:new b.Models.GroupCollection(WPCA.groups,{parse:!0})})}};a(document).ready(function(){d.init()})}(jQuery,CAE);