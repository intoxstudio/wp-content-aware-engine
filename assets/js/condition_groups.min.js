/*!
 * @package WP Content Aware Engine
 * @version 1.0
 * @copyright Joachim Jensen <jv@intox.dk>
 * @license GPLv3
 */
!function(a){function b(){this._init=function(){var b=this,c=a(".cas-group-single",this.getGroupContainer()).first();c.length?(a(".cas-group-single input:checkbox").attr("disabled",!0),this.setCurrent(c)):a(".accordion-section-content input").attr("disabled",!0),this.getGroupContainer().on("change","input",function(){$this=a(this);var c=b._oldOptions[$this.attr("name")];"undefined"!=typeof c&&$this.is(":checked")!==c?b._optionsChanged++:b._optionsChanged--})},this._$groupContainer=a("#cas-groups"),this._currentGroup=null,this._oldOptions={},this._optionsChanged=0,this._activeClass="cas-group-active",this.setOldOptions=function(){var b=this;this._optionsChanged=0,this.getCurrent().find(".js-cas-group-option").each(function(){$this=a(this),b._oldOptions[$this.attr("name")]=$this.is(":checked")})},this.add=function(b){var d=this.setCurrent(b);d&&(c.dismiss(),this.hasGroups()||this.getGroupContainer().addClass("cas-has-groups"),a("ul",this._$groupContainer).first().append(b))},this.remove=function(a){var b=this;a.css("background","#FFEBE8").fadeOut("slow",function(){a.remove(),b.hasGroups()||b.getGroupContainer().removeClass("cas-has-groups")})},this.setCurrent=function(a){var b=!0;return a.length?this.getCurrent()&&(b=this.resetCurrent()):b=!1,b&&(this._currentGroup=a,this.setOldOptions(),this._setActive(!0)),b},this.resetCurrent=function(){var b,d=!0;c.dismiss();var e=this;return this.getCurrent()&&(this.isNewGroup()?(b=!0,this.hasUnsavedRules()&&(b=confirm(WPCA.confirmCancel)),b?(this._setActive(!1),this.remove(this.getCurrent()),this._currentGroup=null,this._oldOptions={}):d=!1):(b=!0,this.hasUnsavedRules()&&(b=confirm(WPCA.confirmCancel)),b?(a("li.cas-new",this.getCurrent()).remove(),a(".cas-condition",this.getCurrent()).each(function(){a(this).find("input").length||a(this).remove()}),a.each(this._oldOptions,function(b,c){a("input[name='"+b+"']",e.getCurrent()).attr("checked",c)}),a("li").fadeIn("slow"),this._setActive(!1),this._currentGroup=null):d=!1)),d},this.getCurrent=function(){return this._currentGroup},this.isNewGroup=function(){return!this.getCurrent().find(".cas_group_id").length},this.hasUnsavedRules=function(){return this._optionsChanged>0||this.getCurrent().find("li.cas-new").length>0},this.hasGroups=function(){return a(".cas-group-single",this.getGroupContainer()).length>0},this._setActive=function(b){a(".accordion-section-content input").attr("disabled",!b),a(".accordion-container").toggleClass("accordion-disabled",!b),this.getCurrent().toggleClass(this._activeClass,b);var c=a("input:checkbox",this.getCurrent());c.attr("disabled",!b),b&&c.not(".js-cas-group-option").attr("checked",!0)},this.getGroupContainer=function(){return this._$groupContainer},this._init()}var c={_$message:null,set:function(b,c){this._$message&&this._$message.remove(),this._$message=a('<div class="cas-alert"><div class="'+c+'"><p>'+b+"</p></div></div>"),this._$message.fadeIn("slow").appendTo("body")},dismiss:function(){this._$message&&this._$message.fadeOut("slow",function(){a(this).remove()})}},d={groups:new b,nonce:a("#_ca_nonce").val(),sidebarID:a("#current_sidebar").val(),init:function(){this.groups.getGroupContainer().on("change",".cas-content input:checkbox",function(){var b=a(this);if(!b.is("checked")){var c=b.closest("li");c.hasClass("cas-new")?c.remove():c.hide()}}),this.addPaginationListener(),this.addTabListener(),this.addPublishListener(),this.addSearchListener(),this.addNewGroupListener(),this.addSetGroupListener(),this.addAddContentListener()},addPublishListener:function(){a("#publish").click(function(a){var b=d.groups.resetCurrent();b||a.preventDefault()})},addPaginationListener:function(){a(".cas-contentlist").on("click",".page-numbers",function(b){b.preventDefault();var c=a(this),e=c.closest(".cas-rule-content");a.ajax({url:ajaxurl,data:c.attr("href").split("?")[1]+"&nonce="+d.nonce+"&sidebar_id="+d.sidebarID+"&action=wpca/module/"+e.attr("data-cas-module"),dataType:"JSON",type:"POST",success:function(a){c.closest(".cas-contentlist").html(a)},error:function(a){}})})},addAddContentListener:function(){a("#cas-accordion").on("click",".js-cas-condition-add",function(b){if(b.preventDefault(),null!==d.groups.getCurrent()){var c=a(this),e=a("input:checkbox:checked, .cas-text-input",c.closest(".cas-rule-content")),f=a(".cas-condition-"+c.attr("data-cas-condition"),d.groups.getCurrent()),g=[];f.length||(f=a('<div class="cas-condition cas-condition-'+c.attr("data-cas-condition")+'"><div class="cas-group-sep">'+WPCA.and+"</div><h4>"+c.closest(".accordion-section").find(".accordion-section-title").text()+"</h4><ul></ul></div>"),d.groups.getCurrent().find(".cas-content").append(f)),e.each(function(){var b=a(this);if(!f.find("input[value='"+b.val()+"']").length){var c;if("checkbox"!=b.attr("type")){if(!b.val())return!0;c=a('<li class="cas-new"><label><input value="'+b.val()+'" name="'+b.attr("name")+'" type="checkbox" checked="checked" />'+b.val()+"</label></li>")}else c=b.closest("li").clone().addClass("cas-new");c.append("&nbsp;"),g.push(c[0])}}),e.attr("checked",!1),a("ul",f).append(g)}})},addNewGroupListener:function(){this.groups.getGroupContainer().on("click",".js-cas-group-new",function(b){b.preventDefault();var c="casn"+(new Date).getTime(),e=a("<li>",{"class":"cas-group-single cas-group-single-new",html:'<div class="cas-group-body"><span class="cas-group-control cas-group-control-active"><input type="button" class="button js-cas-group-save" value="'+WPCA.save+'" /> | <a class="js-cas-group-cancel" href="#">'+WPCA.cancel+'</a></span><span class="cas-group-control"><a class="js-cas-group-edit" href="#">'+WPCA.edit+'</a> | <a class="submitdelete trash js-cas-group-remove" href="#">'+WPCA.remove+'</a></span><div class="cas-content"></div><div class="menu-settings cas-group-settings"><dl><dt>'+WPCA.negateGroup+'</dt><dd><div class="cas-switch"><input class="js-cas-group-option" type="checkbox" id="'+c+'" name="'+WPCA.prefix+'status" value="1"><label for="'+c+'" data-on="'+WPCA.targetNegate+'" data-off="'+WPCA.targetThis+'"></label></div></dd></dl></div></div><div class="cas-group-sep">'+WPCA.or+"</div>"});d.groups.add(e)})},addSetGroupListener:function(){this.groups.getGroupContainer().on("click",".js-cas-group-save",function(b){b.preventDefault();var e=a(this);e.attr("disabled",!0);var f=d.groups.getCurrent().find("input").serializeArray();f.push({name:"action",value:"wpca/add-rule"}),f.push({name:"token",value:d.nonce}),f.push({name:"current_id",value:d.sidebarID}),a.ajax({url:ajaxurl,data:a.param(f),dataType:"JSON",type:"POST",success:function(b){c.set(b.message,"updated");var f=a(".cas-content input:checkbox",d.groups.getCurrent()).closest("li");f.length>0&&(a(".cas-content input:checkbox:not(:checked)",d.groups.getCurrent()).closest("li").remove(),f.removeClass("cas-new")),d.groups.setOldOptions(),a(".cas-condition",d.groups.getCurrent()).each(function(){a(this).find("input").length||a(this).remove()}),b.new_post_id&&d.groups.getCurrent().append('<input type="hidden" class="cas_group_id" name="cas_group_id" value="'+b.new_post_id+'" />'),e.attr("disabled",!1)},error:function(a){c.set(a.responseText,"error"),e.attr("disabled",!1)}})}).on("click",".js-cas-group-cancel",function(a){a.preventDefault(),d.groups.resetCurrent()}).on("click",".js-cas-group-edit",function(b){b.preventDefault(),d.groups.setCurrent(a(this).parents(".cas-group-single"))}).on("click",".js-cas-group-remove",function(b){if(b.preventDefault(),confirm(WPCA.confirmRemove)){var e=a(this);e.attr("disabled",!0);var f=a(this).closest(".cas-group-single");a.ajax({url:ajaxurl,data:{action:"wpca/remove-group",token:d.nonce,cas_group_id:f.find(".cas_group_id").val(),current_id:d.sidebarID},dataType:"JSON",type:"POST",success:function(a){c.set(a.message,"updated"),d.groups.remove(f),e.attr("disabled",!1)},error:function(a){c.set(a.responseText,"error"),e.attr("disabled",!1)}})}})},addTabListener:function(){var b="tabs-panel-active",c="tabs-panel-inactive";a("#cas-accordion .accordion-section:not(.hide-if-js)").first().addClass("open"),a(".nav-tab-link").on("click",function(d){d.preventDefault(),panelId=a(this).data("type"),wrapper=a(this).closest(".accordion-section-content"),a("input",wrapper).removeAttr("checked"),a("."+b,wrapper).removeClass(b).addClass(c),a("#"+panelId,wrapper).removeClass(c).addClass(b),a(".tabs",wrapper).removeClass("tabs"),a(this).parent().addClass("tabs"),a(".quick-search",wrapper).focus()})},addSearchListener:function(){var b;a(".cas-autocomplete").keypress(function(c){var e=a(this);return 13==c.which?(d.updateSearchResults(e),!1):(b&&clearTimeout(b),void(b=setTimeout(function(){d.updateSearchResults(e)},400)))}).attr("autocomplete","off")},updateSearchResults:function(b){var c,e=2,f=b.val();if(!(f.length<e)){c=b.parents(".tabs-panel");var g=a(".spinner",c);g.show();var h=b.closest(".cas-rule-content");a.ajax({url:ajaxurl,data:{action:"wpca/module/"+h.attr("data-cas-module"),nonce:d.nonce,sidebar_id:d.sidebarID,item_object:b.attr("data-cas-item_object"),search:f},dataType:"JSON",type:"POST",success:function(a){data=a?a:"<li><p>"+WPCA.noResults+"</p></li>",c.find(".cas-contentlist").html(data),g.hide()},error:function(a){}})}}};a(document).ready(function(){d.init()})}(jQuery);