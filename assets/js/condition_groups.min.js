/*!
 * @package WP Content Aware Engine
 * @version 2.0
 * @copyright Joachim Jensen <jv@intox.dk>
 * @license GPLv3
 */
var CAE=CAE||{};!function(a,b){"use strict";b.settings={views:{}},b.Models={Alert:Backbone.Model.extend({defaults:{text:"",cssClass:"updated"},sync:function(){return!1},url:"",reset:function(){this.set(this.defaults)}}),Condition:Backbone.Model.extend({unsaved:{prompt:WPCA.unsaved,unloadWindowPrompt:!0},defaults:{module:null,label:null,values:[],options:{}},initialize:function(){this.startTracking(),this.on("destroy",this.stopTracking,this)},sync:function(){return!1},url:""}),Group:Backbone.Model.extend({unsaved:{prompt:WPCA.unsaved,unloadWindowPrompt:!0},defaults:{id:null,status:"publish",exposure:1,options:{}},initialize:function(){this.conditions||(this.conditions=new b.Models.ConditionCollection),this.startTracking(),this.on("destroy",this.stopTracking,this)},parse:function(a){if(_.has(a,"conditions")){var c=[];for(var d in a.conditions)if(a.conditions.hasOwnProperty(d)){var e=[];for(var f in a.conditions[d].data)a.conditions[d].data.hasOwnProperty(f)&&e.push({text:a.conditions[d].data[f],id:f});c.push({label:a.conditions[d].label,module:d,values:e,options:a.conditions[d].options||{}})}this.conditions=new b.Models.ConditionCollection(c),delete a.conditions}return a},sync:function(){return!1},url:""}),GroupCollection:Backbone.Collection.extend({model:function(a,c){return new b.Models.Group(a,c)},parse:function(a){return a}}),ConditionCollection:Backbone.Collection.extend({model:function(a,c){return new b.Models.Condition(a,c)}})},b.Views={Alert:Backbone.View.extend({tagName:"div",className:"wpca-alert",template:_.template('<div class="<%= cssClass %>"><%= text %></div>'),timer:4e3,success:function(a){this.model.set({text:a,cssClass:"wpca-success"})},failure:function(a){this.model.set({text:a,cssClass:"wpca-error"})},dismiss:function(){this.model.reset()},initialize:function(){this.listenTo(this.model,"change",this.render),this.$el.appendTo("body")},render:function(){if(""!==this.model.get("text")){var a=this;this.$el.hide().html(this.template(this.model.attributes)).fadeIn("slow"),setTimeout(function(){a.$el.fadeOut("slow"),a.dismiss()},this.timer)}else this.$el.fadeOut("slow")}}),Condition:Backbone.Epoxy.View.extend({tagName:"div",className:"cas-condition",events:{"click .js-wpca-condition-remove":"removeModel"},initialize:function(){this.listenTo(this.model,"destroy",this.remove);var b=a("#wpca-template-"+this.model.get("module"));b.length?(this.template=_.template(b.html()),this.render()):this.model.destroy()},render:function(){this.$el.append(this.template(this.model.attributes)),this.createSuggestInput()},removeModel:function(a){var b=this;this.$el.slideUp(300,function(){b.model.destroy()})},createSuggestInput:function(){var a=this.$el.find(".js-wpca-suggest");if(a.length){var b=this.model,d=this.model.get("values");a.select2({more:!0,cachedResults:{},quietMillis:400,searchTimer:null,type:this.model.get("module"),theme:"wpca",placeholder:a.data("wpca-placeholder"),minimumInputLength:0,closeOnSelect:!0,width:"100%",language:{noResults:function(){return WPCA.noResults},searching:function(){return WPCA.searching+"..."}},nextSearchTerm:function(a,b){return b},data:d,dataAdapter:c.wpcaDataAdapter,ajax:{}}).on("select2:selecting",function(b){a.data("forceOpen",!0)}).on("select2:close",function(b){a.data("forceOpen")&&(b.preventDefault(),a.select2("open"),a.data("forceOpen",!1))}),d.length&&a.val(_.map(d,function(a){return a.id})).trigger("change"),a.on("change",function(c){var d=a.select2("data");b.set("values",d)})}}}),Group:Backbone.Epoxy.View.extend({bindings:"data-vm",model:b.Models.Group,tagName:"li",className:"cas-group-single",template:_.template(a("#wpca-template-group").html()),events:{"change .js-wpca-add-and":"addConditionModel","click .js-wpca-save-group":"saveGroup"},initialize:function(){this.render(),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model.conditions,"remove",this.conditionRemoved),this.listenTo(this.model.conditions,"add",this.addConditionViewSlide)},render:function(){this.$el.append(this.template(this.model.attributes)),this.model.conditions.each(this.addConditionViewFade,this)},computeds:{statusNegated:{deps:["status"],get:function(a){return"negated"==a},set:function(a){var b=a?"negated":"publish";this.setBinding("status",b)}},exposureSingular:{deps:["exposure"],get:function(a){return 1>=a},set:function(a){var b=this.getBinding("exposureArchive"),c=a&&b?b?1:0:2;this.setBinding("exposure",c)}},exposureArchive:{deps:["exposure"],get:function(a){return a>=1},set:function(a){var b=this.getBinding("exposureSingular"),c=a&&b?b?1:2:0;this.setBinding("exposure",c)}}},addConditionModel:function(c){var d=a(c.currentTarget);if(d.val()&&!this.model.conditions.findWhere({module:d.val()})){var e=new b.Models.Condition({module:d.val(),label:d.children(":selected").text()});this.model.conditions.add(e)}d.val(0).blur()},addConditionView:function(a){if(b.Views[a.get("module")])var c=new(b.Views[a.get("module")])({model:a});else var c=new b.Views.Condition({model:a});return c.$el.hide().appendTo(this.$el.find(".cas-content"))},addConditionViewSlide:function(a){this.addConditionView(a).slideDown(300)},addConditionViewFade:function(a){this.addConditionView(a).fadeIn(300)},conditionRemoved:function(a){this.model.conditions.length||(this.model.get("id")?this.saveGroup():this.removeModel())},removeModel:function(){var a=this;this.$el.slideUp(400,function(){a.model.destroy()})},saveGroup:function(b){var d={action:"wpca/add-rule",token:c.nonce,current_id:c.sidebarID},e=this;this.model.get("id")&&(d.cas_group_id=this.model.get("id")),d._ca_status=this.model.get("status"),d._ca_exposure=this.model.get("exposure"),this.$el.find("input,select").each(function(b,c){var e=a(c),f=e.attr("name");if(f&&("checkbox"!=e.attr("type")||e.is(":checked"))){var g=e.val();~f.indexOf("cas_condition")&&(!g&&e.data("wpca-default")?g=[e.data("wpca-default")]:a.isArray(g)||(g=[g]),d[f]&&(g=g.concat(d[f]))),g&&(d[f]=g)}}),a.ajax({url:ajaxurl,data:d,dataType:"JSON",type:"POST",success:function(a){c.alert.success(a.message),e.model.restartTracking(),e.model.conditions.each(function(a){a.restartTracking()}),a.removed?e.removeModel():a.new_post_id&&e.model.set("id",a.new_post_id)},error:function(a,b,d){c.alert.failure(a.responseText)}})},slideRemove:function(){this.$el.slideUp(400,function(){this.remove()})}}),GroupCollection:Backbone.View.extend({el:"#cas-groups",collection:b.Models.GroupCollection,events:{"change .js-wpca-add-or":"addGroupModel"},initialize:function(){this.listenTo(this.collection,"add",this.addGroupView),this.listenTo(this.collection,"add remove",this.changeLogicText),this.render()},render:function(){this.collection.each(this.addGroupView,this),this.changeLogicText(),a(".js-wpca-add-or").focus()},addGroupModel:function(c){var d=a(c.currentTarget);if(d.val()){var e=new b.Models.Group,f=new b.Models.Condition({module:d.val(),label:d.children(":selected").text()});this.collection.add(e),e.conditions.add(f)}d.val(0).blur()},addGroupView:function(a){var c=new b.Views.Group({model:a});c.$el.hide().appendTo(this.$el.children("ul").first()).fadeIn(300)},changeLogicText:function(){this.$el.find("> .cas-group-sep").toggle(!!this.collection.length)}})},a.fn.select2.amd.define("select2/data/wpcaAdapter",["select2/data/array","select2/utils"],function(b,d){function e(a,b){e.__super__.constructor.call(this,a,b)}return d.Extend(e,b),e.prototype.query=function(b,d){b.term=b.term||"";var e=this.options.options,f=e.cachedResults[b.term],g=b.page||1;if(f&&f.page>=g){if(!(g>1))return void d({results:f.items,pagination:{more:f.more}});g=f.page}clearTimeout(e.searchTimer),e.searchTimer=setTimeout(function(){a.ajax({url:ajaxurl,data:{search:b.term,paged:g,action:"wpca/module/"+e.type,sidebar_id:c.sidebarID,nonce:c.nonce},dataType:"JSON",type:"POST",success:function(a){var c=a,h=!0;c.length<20&&(h=!1),f?e.cachedResults[b.term]={page:g,more:h,items:e.cachedResults[b.term].items.concat(c)}:e.cachedResults[b.term]={page:g,items:c,more:h},d({results:c,pagination:{more:h}})}})},e.quietMillis)},e});var c={nonce:a("#_ca_nonce").val(),sidebarID:a("#current_sidebar").val(),alert:null,wpcaDataAdapter:a.fn.select2.amd.require("select2/data/wpcaAdapter"),init:function(){this.alert=new b.Views.Alert({model:new b.Models.Alert}),b.conditionGroups=new b.Views.GroupCollection({collection:new b.Models.GroupCollection(WPCA.groups,{parse:!0})})}};a(document).ready(function(){c.init()})}(jQuery,CAE);